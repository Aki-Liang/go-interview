# 布隆过滤器

问：如何处理10G的黑名单，黑名单中是UserId，在黑名单中的用户不可访问首页

* 使用bitmap进行匹配

追问：100G的该怎么处理

* 使用布隆过滤器

问：布隆过滤器的原理说一下


## 布隆过滤器原理

![bf](./pic/bf.jpg)


每个布隆过滤器对应到 Redis 的数据结构里面就是一个大型的位数组和几个不一样的无偏 hash 函数。所谓无偏就是能够把元素的 hash 值算得比较均匀。

向布隆过滤器中添加 key 时，会使用多个 hash 函数对 key 进行 hash 算得一个整数索引值然后对位数组长度进行取模运算得到一个位置，每个 hash 函数都会算得一个不同的位置。再把位数组的这几个位置都置为 1 就完成了 add 操作。

向布隆过滤器询问 key 是否存在时，跟 add 一样，也会把 hash 的几个位置都算出来，看看位数组中这几个位置是否都为 1，只要有一个位为 0，那么说明布隆过滤器中这个 key 不存在。如果都是 1，这并不能说明这个 key 就一定存在，只是极有可能存在，因为这些位被置为 1 可能是因为其它的 key 存在所致。如果这个位数组比较稀疏，判断正确的概率就会很大，如果这个位数组比较拥挤，判断正确的概率就会降低。

使用时不要让实际元素远大于初始化大小，当实际元素开始超出初始化大小时，应该对布隆过滤器进行重建，重新分配一个 size 更大的过滤器，再将所有的历史元素批量 add 进去 


## Redis中布隆过滤器使用方式

```
bf.reserve   // 显式创建布隆过滤器

bf.add       // 添加一个元素
bf.exists    // 查询一个元素是否存在
bf.madd      // 批量添加元素
bf.mexists   // 批量查询元素是否存在
```

bf.reserve有三个参数，分别是 key, error_rate和initial_size。错误率越低，需要的空间越大。initial_size参数表示预计放入的元素数量，当实际数量超出这个数值时，误判率会上升


如果不使用 bf.reserve，默认的error_rate是 0.01，默认的initial_size是 100。

## 布隆过滤器空间占用计算

```
k=0.7*(l/n)  # 约等于
f=0.6185^(l/n)  # ^ 表示次方计算，也就是 math.pow
```

第一个是预计元素的数量 n，第二个是错误率 f。公式根据这两个输入得到两个输出，第一个输出是位数组的长度 l，也就是需要的存储空间大小 (bit)，第二个输出是 hash 函数的最佳数量 k。hash 函数的数量也会直接影响到错误率，最佳的数量会有最低的错误率。

* 位数组相对越长 (l/n)，错误率 f 越低，这个和直观上理解是一致的
* 位数组相对越长 (l/n)，hash 函数需要的最佳数量也越多，影响计算效率
* 当一个元素平均需要 1 个字节 (8bit) 的指纹空间时 (l/n=8)，错误率大约为 2%
* 错误率为 10%，一个元素需要的平均指纹空间为 4.792 个 bit，大约为 5bit
* 错误率为 1%，一个元素需要的平均指纹空间为 9.585 个 bit，大约为 10bit
* 错误率为 0.1%，一个元素需要的平均指纹空间为 14.377 个 bit，大约为 15bit